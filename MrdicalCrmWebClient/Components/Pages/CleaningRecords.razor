@page "/cleaning_records"

@rendermode InteractiveServer

@inject DataMock DataMock;

@using Blazorise.DataGrid
@using Blazorise

<Card>
    <CardHeader>
        <Row Class="justify-content-between">
            <Column ColumnSize="ColumnSize.IsAuto">
                <h4>Cleaning Records</h4>
            </Column>
            <Column ColumnSize="ColumnSize.IsAuto">
                <Button Color="Color.Primary" Clicked="ShowAddRecordModal">
                    Add New Record
                </Button>
                <Button Color="Color.Danger" Disabled="@(_selectedRecords.Count == 0)"
                        Clicked="ConfirmDeleteSelectedRecords">
                    Delete Selected
                </Button>
            </Column>
        </Row>
    </CardHeader>
    <CardBody>
        <DataGrid TItem="CleaningRecord"
                  Data="@cleaningRecords"
                  SelectionMode="DataGridSelectionMode.Multiple"
                  @bind-SelectedRows="_selectedRecords"
                  ShowPager="true"
                  PageSize="@GridPageSize"
                  Responsive Striped>
            <DataGridColumns>
                <DataGridMultiSelectColumn TItem="CleaningRecord" Width="30px" />

                <DataGridColumn TItem="CleaningRecord"
                                Field="@nameof(CleaningRecord.Id)"
                                Caption="ID"
                                Sortable="false"
                                Filterable="false" />

                <DataGridColumn TItem="CleaningRecord"
                                Field="@nameof(CleaningRecord.Cabinet)"
                                Caption="Cabinet" />

                <DataGridColumn TItem="CleaningRecord"
                                Field="@nameof(CleaningRecord.EmployeeId)"
                                Caption="Employee ID" />

                <DataGridCommandColumn TItem="CleaningRecord" Width="150px">
                    <DisplayTemplate>
                        <Button Color="Color.Danger" Clicked="@(() => DeleteRecord(context.Id))">
                            Delete
                        </Button>
                    </DisplayTemplate>
                </DataGridCommandColumn>
            </DataGridColumns>

            <LoadingTemplate>
                <p>Loading...</p>
            </LoadingTemplate>

            <EmptyTemplate>
                <p>No records available.</p>
            </EmptyTemplate>
        </DataGrid>
    </CardBody>
</Card>

<Modal @ref="addRecordModal" Size="ModalSize.Small" ShowCloseIcon="true" Style="background-color: white;">
    <ModalHeader>
        <h5>Add New Record</h5>
    </ModalHeader>
    <ModalBody>
        <div class="mb-3">
            <label for="cabinet">Cabinet:</label>
            <input type="number" id="cabinet" @bind="newRecord.Cabinet" class="form-control" />
        </div>
        <div class="mb-3">
            <label for="employeeId">Employee ID:</label>
            <input type="number" id="employeeId" @bind="newRecord.EmployeeId" class="form-control" />
        </div>
    </ModalBody>
    <ModalFooter>
        <Button Color="Color.Primary" Clicked="AddNewRecord">
            Add
        </Button>
        <Button Color="Color.Secondary" Clicked="CancelClicked">
            Cancel
        </Button>
    </ModalFooter>
</Modal>

@code {
    private List<CleaningRecord> cleaningRecords = new();
    private CleaningRecord newRecord = new();
    private List<CleaningRecord> _selectedRecords = new();
    private Modal? addRecordModal = null!;
    private int GridPageSize = 10;

    protected override void OnInitialized()
    {
        cleaningRecords = DataMock.CleaningRecords;
    }

    private async Task ShowAddRecordModal()
    {
        newRecord = new CleaningRecord();
        await addRecordModal!.Show();
    }

    private async Task AddNewRecord()
    {
        if (newRecord.Cabinet != 0 && newRecord.EmployeeId != 0)
        {
            var maxId = cleaningRecords.Any() ? cleaningRecords.Max(x => x.Id) : 0;
            newRecord.Id = maxId + 1;
            cleaningRecords.Add(newRecord);
            await addRecordModal!.Hide();
        }
    }

    private void DeleteRecord(int id)
    {
        var recordToDelete = cleaningRecords.FirstOrDefault(x => x.Id == id);
        if (recordToDelete != null)
        {
            cleaningRecords.Remove(recordToDelete);
        }
    }

    private void ConfirmDeleteSelectedRecords()
    {
        foreach (var record in _selectedRecords.ToList())
        {
            cleaningRecords.Remove(record);
        }
        _selectedRecords.Clear();
    }

    private async Task CancelClicked()
    {
        await addRecordModal.Hide();
    }
}
